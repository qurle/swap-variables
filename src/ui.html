<!-- interface -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');

    :root {
        --transition-rule: 200ms ease-in-out;

        /* 1rem is 16px by default */
        --gap-l: 1rem;
        --gap-m: 0.75rem;
        --gap-s: 0.5rem;
        --gap-xs: 0.25rem;

        --font-size-m: 0.875rem;
        --font-size-s: 0.75rem;
        --font-size-xs: 0.5rem;

        --radius-m: 0.5rem;
        --radius-s: 0.25rem;

        background-color: var(--figma-color-bg);
    }

    :root.figma-light {
        --vk-color-accent-themed: #4586e4;
    }

    :root.figma-dark {
        --vk-color-accent-themed: #ffffff;
    }


    * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        color: var(--figma-color-text);
    }

    *:focus-visible {
        outline: 1px solid var(--figma-color-border-selected);
        outline-offset: 2px;
    }


    .border-extender {
        position: relative;
        height: 1rem;
        background: var(--figma-color-border);
    }

    .border-extender>div {
        position: absolute;
        height: 0.5rem;
        width: 100%;
        border-radius: var(--radius-m) var(--radius-m) 0 0;
        background: var(--figma-color-bg);
        bottom: 0;
    }

    .container {
        height: calc(100%-1rem);
        width: 100%;
        padding: var(--gap-l);
        font-size: var(--font-size-m);
    }

    .container,
    form {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: stretch center;
        gap: var(--gap-l);
    }

    .select label {
        display: block;
        padding: 0 var(--gap-s);
        margin-bottom: var(--gap-s);
        font-size: var(--font-size-s);
        color: var(--figma-color-text-secondary);
    }

    .select-wrapper {
        position: relative;
        border: 1px solid var(--figma-color-border);
        border-radius: var(--radius-m);
        transition: background-color var(--transition-rule);
    }

    .select-wrapper::after {
        position: absolute;
        right: 1rem;
        top: 50%;
        translate: 0 -75%;
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        border-right: 1px solid var(--figma-color-icon);
        border-bottom: 1px solid var(--figma-color-icon);
        rotate: 45deg;
        pointer-events: none;
    }

    .select-wrapper:hover {
        background-color: var(--figma-color-bg-hover);
    }

    select {
        appearance: none;
        width: 100%;
        padding: 0.75rem 2rem 0.75rem 1rem;
        border: none;
        border-radius: var(--radius-m);
        background: none;
    }

    select:focus {
        outline: none;
        background-color: var(--figma-color-bg-hover);
    }

    .segmented {
        appearance: none;
        border: none;

        display: flex;
        padding: 3px;

        border-radius: var(--radius-m);
        background-color: var(--figma-color-bg-secondary);
        border: 1px solid var(--figma-color-border);
    }

    .segmented input {
        appearance: none;
        position: absolute;

        height: 100%;
        width: 100%;

        border-radius: calc(var(--radius-m) - 3px);
        background-color: transparent;
        box-shadow: none;
        transition: background-color var(--transition-rule), transform var(--transition-rule), box-shadow var(--transition-rule);

        pointer-events: all;
        cursor: pointer;
    }

    .segmented label {
        appearance: none;

        position: relative;
        display: flex;

        align-items: center;
        justify-content: center;
        flex-grow: 1;

        gap: var(--gap-xs);
        padding: var(--gap-s);

        pointer-events: none;
    }

    .segmented input~span {
        z-index: 1;
        opacity: 0.6;
        transition: opacity var(--transition-rule);
    }

    .segmented input:checked {
        background-color: var(--figma-color-bg);
        box-shadow: 0 2px 8px -4px #00000040;
    }

    .segmented input:checked~span {
        opacity: 1;
    }


    .segmented input:active {
        transform: scale(.95);
    }

    .segmented .tooltip {
        position: absolute;
        top: calc(-1 * var(--gap-s));
        right: 0;
        width: 8rem;

        opacity: 0;

        border-radius: var(--radius-s);
        padding: var(--gap-s);

        background-color: var(--figma-color-bg-inverse);
        color: var(--figma-color-text-oninverse);

        transform: translateY(-90%);
        transition: transform var(--transition-rule), opacity var(--transition-rule);
    }

    .segmented input:hover~.tooltip,
    .segmented input:focus-visible~.tooltip {
        opacity: 1;
        transform: translateY(-100%);
    }

    .buttons {
        display: flex;
        width: 100%;
        gap: var(--gap-s);
    }

    button {
        cursor: pointer;
        padding: 1rem;

        color: var(--figma-color-text-oninverse);
        border: none;
        outline: none;
        background: none;
        border-radius: var(--radius-m);

        letter-spacing: 0.02;
        transition: background-color var(--transition-rule), transform var(--transition-rule);
    }

    button:hover {
        background: var(--figma-color-bg-hover);
    }

    button:active {
        transform: scale(0.98);
    }

    button.primary {
        width: 100%;
        background: var(--vk-color-accent-themed);
        color: var(--figma-color-bg-secondary);
        opacity: 1;
    }

    button.primary:disabled {
        animation: loading 1000ms ease-in-out 0 infinite alternate;
    }

    @keyframes loading {
        to {
            opacity: 0;
        }
    }

    button.primary:hover {
        transition: opacity var(--transition-rule), box-shadow var(--transition-rule);
        opacity: 0.95;
    }

    .figma-light button.primary {
        box-shadow: 4px 4px 8px 0px rgba(255, 255, 255, 0.10) inset, -4px -4px 8px 0px rgba(0, 0, 0, 0.05) inset, 0px 16px 16px -8px rgba(38, 136, 235, 0.25);
    }

    button.secondary {
        padding-top: 0;
        padding-bottom: 0;
        border: 1px solid var(--figma-color-border);
    }

    a {
        margin: 0 auto;
        color: var(--figma-color-text-tertiary);
        text-decoration-color: transparent;
        text-underline-offset: 4px;

        border-radius: var(--radius-s);
        transition: text-decoration-color var(--transition-rule);
    }

    a:hover {
        text-decoration-color: var(--figma-color-text-tertiary);
    }

    svg {
        color: var(--figma-color-icon);
    }

    .errors {
        display: flex;
        display: none;
        flex-direction: column;
        gap: var(--gap-m);
        margin-top: var(--gap-s);
    }

    .errors h2 {
        font-size: var(--font-size-m);
        font-weight: normal;
        color: var(--figma-color-icon-danger);
    }

    .errors h3 {
        font-size: var(--font-size-s);
        font-weight: normal;
        color: var(--figma-color-text-secondary);
    }

    .errors ul {
        display: flex;
        display: none;
        flex-direction: column;
        gap: var(--gap-xs);
    }

    .errors li {
        display: flex;
        font-size: var(--font-size-s);
        padding: var(--gap-s) var(--gap-m);
        gap: var(--gap-s);
        transition: background-color var(--transition-rule), transform var(--transition-rule);
        cursor: pointer;
        border-radius: var(--radius-s);
    }

    .errors li:hover {
        background: var(--figma-color-bg-hover);
    }

    .errors li:active {
        transform: scale(0.98);
    }

    .errors li p {
        width: 100%;
    }

    .errors li div {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 1rem;
        border-radius: var(--radius-s);
        font-size: var(--font-size-xs);
        max-width: 20%;
    }

    .errors li p,
    .errors li div {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
</style>
<div class="border-extender">
    <div></div>
</div>
<div class="container">
    <form>
        <div class="select">
            <label for="from">Source</label>
            <div class="select-wrapper">
                <select id="from" name="from">
                    <option class="stub">Loading...</option>
                </select>
            </div>
        </div>
        <div class="select">
            <label for="to">Swap to</label>
            <div class="select-wrapper">
                <select id="to" name="to">
                    <option class="stub">Loading...</option>
                </select>
            </div>
        </div>
        <fieldset class="segmented scope">
            <label>
                <input type="radio" name="scope" value="selection" checked />
                <span>Selection</span></label>
            <label>
                <input type="radio" name="scope" value="page" />
                <span>This page</label>
            <label>
                <input type="radio" name="scope" value="all" />
                <span>All pages</span>
                <div class="tooltip">
                    Careful. It might take a lot of time
                </div>
            </label>
        </fieldset>
        <div class="buttons">
            <button title="Reverse collections" class="secondary reverse" type="button">
                <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path opacity="0.5" d="M16 18.5V6.5M16 6.5L20 10.625M16 6.5L12 10.625" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M8 6.5V18.5M8 18.5L12 14.375M8 18.5L4 14.375" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            <button type="submit" class="primary">Swap Variables</button>
        </div>
        <a target="_top" href="mailto:nikita.denisov@vk.team?subject=Swap%20Variables">Send feedback</a>
        <div class="errors">
            <h2>0 errors</h2>
            <ul class="limitation">
                <h3>Figma limitations</h3>
            </ul>
            <ul class="no-match">
                <h3>No matches</h3>
            </ul>
            <ul class="mixed">
                <h3>Text with mixed colors</h3>
            </ul>
            <ul class="bad-prop">
                <h3>Bad properties</h3>
            </ul>
            <ul class="unsupported">
                <h3>Unsupported by Plugin API</h3>
            </ul>
        </div>
    </form>
</div>
<script>
    console.time('Query selecting')
    const form = document.querySelector('form')
    const selectFrom = form.querySelector('select[name=from]')
    const selectTo = form.querySelector('select[name=to]')
    const scopeSelect = form.querySelector('.scope')
    const reverse = form.querySelector('button.reverse')
    const errorsEl = document.querySelector('.errors')
    const heading = errorsEl.querySelector('h2')
    const submit = form.querySelector('button[type=submit]')
    const loader = document.querySelector('.loader')

    const lists = {
        limitation: errorsEl.querySelector('ul.limitation'),
        noMatch: errorsEl.querySelector('ul.no-match'),
        mixed: errorsEl.querySelector('ul.mixed'),
        badProp: errorsEl.querySelector('ul.bad-prop'),
        unsupported: errorsEl.querySelector('ul.unsupported')
    }

    console.timeEnd('Query selecting')


    window.onmessage = async (event) => {
        const type = event.data.pluginMessage.type
        const message = event.data.pluginMessage.message
        console.log(`Got ${type} message ↴`)
        console.log(message)

        switch (type) {
            case 'scope':
                defineScope(message.scope)
                break
            case 'collections':
                fillLibs(message.collections, message.current)
                break
            case 'finish':
                finish(message.errors, message.newCollection)
                break

        }
    }

    form.onsubmit = (event) => {
        console.time('Submitting')
        event.preventDefault()
        clearErrors()

        submit.disabled = true
        submit.innerText = 'Swapping...'

        const from = selectFrom.selectedOptions[0]
        const to = selectTo.selectedOptions[0]

        const scope = scopeSelect.querySelector('input:checked').value
        console.log('Checked scope ↴')
        console.log(scopeSelect.querySelector('input:checked'))

        parent.postMessage({
            pluginMessage: {
                type: 'swap', message: {
                    collections: {
                        from: {
                            lib: from.dataset.lib,
                            name: from.dataset.name,
                            key: from.dataset.key,
                            id: from.dataset.id,
                            local: from.dataset.local === 'true',
                            modes: JSON.parse(from.dataset.modes)
                        },
                        to: to.dataset.id ? {
                            lib: to.dataset.lib,
                            name: to.dataset.name,
                            key: to.dataset.key,
                            id: to.dataset.id,
                            local: to.dataset.local === 'true',
                            modes: JSON.parse(to.dataset.modes)
                        } : null
                    },
                    scope: scope
                }
            }
        }, '*')

        console.timeEnd('Submitting')

    }

    reverse.onclick = (event) => {
        reverseSelects()
    }

    function reverseSelects() {
        const fromIndex = selectFrom.selectedIndex
        const toIndex = selectTo.selectedIndex

        selectFrom.options[toIndex].selected = true
        selectTo.options[fromIndex].selected = true
    }

    function fillLibs(collections, currentCollection) {
        console.time('Filling libs')
        const options = Object.groupBy(collections, ({ lib }) => lib)

        for (const [lib, collections] of Object.entries(options)) {
            const optgroup = document.createElement('optgroup')
            optgroup.label = lib
            for (const collection of collections) {
                const option = document.createElement('option')
                option.textContent = `${lib.slice(0, 8)}... > ${collection.name}`
                option.dataset.lib = lib
                option.dataset.name = collection.name
                option.dataset.key = collection.key
                option.dataset.id = collection.id
                option.dataset.local = collection.local
                option.dataset.modes = JSON.stringify(collection.modes)
                optgroup.appendChild(option)
            }
            selectFrom.appendChild(optgroup)
            selectTo.appendChild(optgroup.cloneNode(true))
        }
        const optgroup = document.createElement('optgroup')

        // Create new collection collection
        const separator = document.createElement('hr')

        const option = document.createElement('option')
        option.textContent = `➕ New local collection`

        selectTo.appendChild(separator)
        selectTo.appendChild(option)

        // Remove loading
        selectFrom.removeChild(selectFrom.querySelector('option.stub'))
        selectTo.removeChild(selectTo.querySelector('option.stub'))

        if (currentCollection) {
            selectByKey(selectFrom, currentCollection)
        }

        console.timeEnd('Filling libs')

    }

    function defineScope(scope) {
        console.log(`Defining scope: ${scope}`)
        if (['selection', 'page', 'all'].includes(scope))
            scopeSelect.querySelector(`input[value=${scope}]`).checked = true
    }

    function finish(errors, newCollection) {
        showErrors(errors)
        if (newCollection) {
            addLocalCollection(newCollection)
            selectByKey(selectTo, newCollection.key)
        }

        submit.disabled = false
        submit.innerText = 'Swap Variables'
        reverseSelects()
    }

    function selectByKey(select, key) {
        Array.from(select.options).find(el => el.dataset.key === key).selected = true
    }

    function addLocalCollection(newCollection) {
        const option = document.createElement('option')

        option.textContent = `${newCollection.lib.slice(0, 8)}... > ${newCollection.name}`
        option.dataset.lib = newCollection.lib
        option.dataset.name = newCollection.name
        option.dataset.key = newCollection.key
        option.dataset.id = newCollection.id
        option.dataset.local = JSON.stringify(newCollection.local)

        const localOptgroupSelector = `optgroup[label="${newCollection.lib}"]`
        let localOptgroupFrom = selectFrom.querySelector(localOptgroupSelector)
        if (!localOptgroupFrom) {
            const optgroup = document.createElement('optgroup')
            optgroup.label = newCollection.lib
            localOptgroupFrom = selectFrom.appendChild(optgroup)
        }
        let localOptgroupTo = selectTo.querySelector(localOptgroupSelector)
        if (!localOptgroupTo) {
            const divider = selectTo.querySelector('hr')
            const optgroup = document.createElement('optgroup')
            optgroup.label = newCollection.lib
            localOptgroupTo = selectTo.insertBefore(optgroup, divider)
        }

        localOptgroupFrom.appendChild(option)
        localOptgroupTo.appendChild(option.cloneNode(true))
    }

    function showErrors(errorsObj) {
        const errorCount = Object.values(errorsObj).reduce((acc, err) => acc + err.length, 0)
        if (errorCount === 0) return

        const limitationSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" ><path stroke="currentColor" d="M8 14.67A6.67 6.67 0 1 0 8 1.33a6.67 6.67 0 0 0 0 13.34Z" opacity=".5" vector-effect="non-scaling-stroke"/><path stroke="currentColor" stroke-linecap="round" d="M6 11.33a3.35 3.35 0 0 1 4 0" vector-effect="non-scaling-stroke"/><path fill="currentcolor" d="M10 8c.37 0 .67-.45.67-1s-.3-1-.67-1c-.37 0-.67.45-.67 1s.3 1 .67 1ZM6 8c.37 0 .67-.45.67-1S6.37 6 6 6c-.37 0-.67.45-.67 1s.3 1 .67 1Z"/></svg>`
        const mixedSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" > <g opacity=".9"><path fill="currentColor" d="M2.34 13.66A8 8 0 0 1 13.66 2.34L2.34 13.66Z" /><path stroke="currentColor" stroke-width="2" d="M3.05 12.95a7 7 0 1 1 9.9-9.9 7 7 0 0 1-9.9 9.9Z" opacity=".5" vector-effect="non-scaling-stroke" /></g></svg>`
        const badPropSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" ><path stroke="currentColor" d="M8 14.67A6.67 6.67 0 1 0 8 1.33a6.67 6.67 0 0 0 0 13.34Z" opacity=".5" vector-effect="non-scaling-stroke"/><path stroke="currentColor" stroke-linecap="round" d="M8 4v5" vector-effect="non-scaling-stroke"/><path fill="currentcolor" d="M8 12.33A.67.67 0 1 0 8 11a.67.67 0 0 0 0 1.33Z"/></svg>`
        const unsupportedSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none" ><path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="currentColor"/><path opacity="0.5" d="M9.17667 1.43467C8.932 1.33333 8.62134 1.33333 8 1.33333C7.37867 1.33333 7.068 1.33333 6.82334 1.43467C6.66146 1.50168 6.51437 1.59993 6.39049 1.72382C6.2666 1.8477 6.16835 1.99479 6.10134 2.15667C6.04 2.30533 6.01534 2.47933 6.006 2.732C6.00185 2.91466 5.95134 3.09327 5.85921 3.25105C5.76708 3.40883 5.63637 3.5406 5.47934 3.634C5.31993 3.72336 5.14043 3.77073 4.95769 3.77167C4.77495 3.7726 4.59498 3.72706 4.43467 3.63933C4.21067 3.52067 4.04867 3.45533 3.888 3.434C3.53755 3.38791 3.18314 3.48287 2.90267 3.698C2.69334 3.86 2.53734 4.12867 2.22667 4.66667C1.916 5.20467 1.76 5.47333 1.726 5.73667C1.70309 5.9103 1.71462 6.08675 1.75991 6.25593C1.80521 6.42511 1.8834 6.58371 1.99 6.72267C2.08867 6.85067 2.22667 6.958 2.44067 7.09267C2.756 7.29067 2.95867 7.628 2.95867 8C2.95867 8.372 2.756 8.70933 2.44067 8.90667C2.22667 9.042 2.088 9.14933 1.99 9.27733C1.8834 9.41629 1.80521 9.57489 1.75991 9.74407C1.71462 9.91325 1.70309 10.0897 1.726 10.2633C1.76067 10.526 1.916 10.7953 2.226 11.3333C2.53734 11.8713 2.69267 12.14 2.90267 12.302C3.04163 12.4086 3.20023 12.4868 3.36941 12.5321C3.53859 12.5774 3.71503 12.5889 3.88867 12.566C4.04867 12.5447 4.21067 12.4793 4.43467 12.3607C4.59498 12.2729 4.77495 12.2274 4.95769 12.2283C5.14043 12.2293 5.31993 12.2766 5.47934 12.366C5.80134 12.5527 5.99267 12.896 6.006 13.268C6.01534 13.5213 6.03934 13.6947 6.10134 13.8433C6.16835 14.0052 6.2666 14.1523 6.39049 14.2762C6.51437 14.4001 6.66146 14.4983 6.82334 14.5653C7.068 14.6667 7.37867 14.6667 8 14.6667C8.62134 14.6667 8.932 14.6667 9.17667 14.5653C9.33855 14.4983 9.48563 14.4001 9.60952 14.2762C9.73341 14.1523 9.83166 14.0052 9.89867 13.8433C9.96 13.6947 9.98467 13.5213 9.994 13.268C10.0073 12.896 10.1987 12.552 10.5207 12.366C10.6801 12.2766 10.8596 12.2293 11.0423 12.2283C11.2251 12.2274 11.405 12.2729 11.5653 12.3607C11.7893 12.4793 11.9513 12.5447 12.1113 12.566C12.285 12.5889 12.4614 12.5774 12.6306 12.5321C12.7998 12.4868 12.9584 12.4086 13.0973 12.302C13.3073 12.1407 13.4627 11.8713 13.7733 11.3333C14.084 10.7953 14.24 10.5267 14.274 10.2633C14.2969 10.0897 14.2854 9.91325 14.2401 9.74407C14.1948 9.57489 14.1166 9.41629 14.01 9.27733C13.9113 9.14933 13.7733 9.042 13.5593 8.90733C13.4032 8.81241 13.2737 8.67933 13.1831 8.52062C13.0925 8.3619 13.0437 8.18275 13.0413 8C13.0413 7.628 13.244 7.29067 13.5593 7.09333C13.7733 6.958 13.912 6.85067 14.01 6.72267C14.1166 6.58371 14.1948 6.42511 14.2401 6.25593C14.2854 6.08675 14.2969 5.9103 14.274 5.73667C14.2393 5.474 14.084 5.20467 13.774 4.66667C13.4627 4.12867 13.3073 3.86 13.0973 3.698C12.9584 3.59139 12.7998 3.51321 12.6306 3.46791C12.4614 3.42261 12.285 3.41109 12.1113 3.434C11.9513 3.45533 11.7893 3.52067 11.5647 3.63933C11.4044 3.72694 11.2246 3.77242 11.042 3.77148C10.8594 3.77055 10.68 3.72324 10.5207 3.634C10.3636 3.5406 10.2329 3.40883 10.1408 3.25105C10.0487 3.09327 9.99816 2.91466 9.994 2.732C9.98467 2.47867 9.96067 2.30533 9.89867 2.15667C9.83166 1.99479 9.73341 1.8477 9.60952 1.72382C9.48563 1.59993 9.33855 1.50168 9.17667 1.43467Z" stroke="currentColor"/></svg>`

        heading.textContent = errorCount + ' error' + (errorCount === 1 ? '' : 's')
        errorsEl.style.display = 'flex'

        for (const [key, errors] of Object.entries(errorsObj)) {
            if (errors.length > 0) {
                errors.map(error => {

                    const selectNode = (event) => {
                        parent.postMessage({
                            pluginMessage: {
                                type: 'goToNode', message: {
                                    nodeId: error.nodeId
                                }
                            }
                        }, '*')
                    }

                    let errorText
                    let icon = document.createElement('div')
                    switch (key) {
                        case 'limitation':
                            errorText = `Only ${error.maxModes} modes available of ${error.currentModes}`
                            icon.innerHTML = limitationSVG
                            break
                        case 'noMatch':
                            errorText = error.name + ' not found'
                            switch (error.type) {
                                case 'COLOR':
                                    icon.style.background = error.value
                                    icon.style.width = '1rem'
                                    icon.style.border = '1px solid var(--figma-color-border)'
                                    break
                                case 'TEXT':
                                case 'BOOLEAN':
                                case 'NUMBER':
                                    icon.style.background = 'var(--figma-color-bg-tertiary)'
                                    icon.style.padding = '0 0.25rem'
                                    icon.textContent = error.value
                                    break
                            }
                            break
                        case 'mixed':
                            errorText = `${error.nodeName} has mixed fills`
                            icon.innerHTML = mixedSVG
                            break
                        case 'badProp':
                            errorText = `Can't check ${error.property} of ${error.nodeName}`
                            icon.innerHTML = badPropSVG
                            break
                        case 'unsupported':
                            errorText = `Can't check ${error.property} of ${error.type.toLowerCase()} ${error.nodeName}`
                            icon.innerHTML = unsupportedSVG
                            break
                    }
                    const text = document.createElement('p')
                    text.textContent = errorText
                    const listItem = document.createElement('li')
                    listItem.tabIndex = '0'
                    listItem.addEventListener('click', selectNode)
                    listItem.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' || event.key === 'Space') {
                            console.log(`Selected ${error.nodeId}`)
                            selectNode()
                        }
                    })

                    listItem.appendChild(text)
                    listItem.appendChild(icon)
                    lists[key].appendChild(listItem)
                })
                lists[key].style.display = 'flex'
            }
        }
    }

    function clearErrors() {
        document.querySelectorAll('.errors ul').forEach(el => {
            el.style.display = 'none'
            el.querySelectorAll('li').forEach(el => { el.remove() })
        })
        errorsEl.style.display = 'none'
    }

    Object.prototype.groupBy = (arr, callback) => {
        return arr.reduce((acc = {}, ...args) => {
            const key = callback(...args)
            acc[key] ??= []
            acc[key].push(args[0])
            return acc
        }, {})
    }
</script>